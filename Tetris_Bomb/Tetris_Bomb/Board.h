#pragma once
#include "Common.h"
#include "Block.h"

/*
 * 파일명: Board.h
 * 설명: Tetris 게임의 보드(격자) 상태를 관리하는 Board 클래스의 선언부입니다.
 * 게임판의 데이터 저장, 충돌 감지, 줄 삭제, 특수 효과(폭발) 등을 담당합니다.
 */

namespace Tetris {

    class Board {
    private:
        // ===========================================================
        // [멤버 변수] 보드 상태 데이터
        // ===========================================================

        /* * [메모리 최적화]
         * 보드 상태(0:빈곳, 1:채워짐)는 0과 1만 사용하므로,
         * int(4바이트) 대신 unsigned char(1바이트)를 사용하여
         * 메모리 사용량을 줄이고 캐시 효율(Cache Hit Rate)을 높였습니다.
         */
        unsigned char grid[BOARD_HEIGHT][BOARD_WIDTH];

        int level; // 현재 레벨 (벽 색상 결정 등에 사용)

    public:
        // ===========================================================
        // [상수 및 생성자]
        // ===========================================================
        static constexpr int EMPTY = 0;  // 빈 공간 값
        static constexpr int FILLED = 1; // 채워진 공간(벽/블록) 값

        Board();


        // ===========================================================
        // [기본 기능] 설정 및 출력
        // ===========================================================

        // 레벨 설정 (벽 색상 변경)
        void setLevel(int lvl);

        // 보드 초기화 (테두리는 벽, 내부는 빈 공간)
        void reset();

        // 보드 상태 화면 출력
        void draw() const;


        // ===========================================================
        // [게임 로직] 충돌, 병합, 삭제
        // ===========================================================

        /*
         * [함수: checkCollision]
         * 설명: 블록(b)이 다음 위치(nextX, nextY)로 이동하거나 회전했을 때
         * 벽이나 다른 블록과 충돌하는지 검사합니다.
         */
        bool checkCollision(const BlockBase& b, int nextX, int nextY, int nextAngle) const;

        /*
         * [함수: merge]
         * 설명: 바닥에 닿은 블록을 보드 데이터(grid)에 고정시킵니다.
         */
        void merge(const BlockBase& b);

        /*
         * [함수: processFullLines]
         * 설명: 꽉 찬 줄을 찾아 삭제하고, 위의 블록들을 내립니다.
         * 리턴: 삭제된 줄의 개수
         */
        int processFullLines();


        // ===========================================================
        // [특수 스킬]
        // ===========================================================

        /*
         * [함수: explode]
         * 설명: 폭탄 스킬 사용 시 특정 좌표(centerX, centerY) 주변 3x3 영역을 파괴합니다.
         * 리턴: 파괴된 블록의 개수
         */
        int explode(int centerX, int centerY);
    };
}